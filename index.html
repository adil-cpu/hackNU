<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zaman Bank AI Assistant</title>
    <style>
        /* –ë–∞–∑–æ–≤—ã–µ —Å—Ç–∏–ª–∏ */
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: #f4f7f6;
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
        }

        /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä —á–∞—Ç–∞ */
        .chat-container {
            width: 95%;
            max-width: 420px;
            height: 90vh;
            max-height: 750px;
            background-color: #ffffff;
            border-radius: 16px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* –ó–∞–≥–æ–ª–æ–≤–æ–∫ —á–∞—Ç–∞ */
        .chat-header {
            background: linear-gradient(90deg, rgba(0,102,102,1) 0%, rgba(0,128,128,1) 100%);
            color: white;
            padding: 15px 20px;
            text-align: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            flex-shrink: 0;
        }
        .chat-header h2 {
            margin: 0;
            font-size: 1.2rem;
        }
        .chat-header p {
            margin: 5px 0 0;
            font-size: 0.8rem;
            opacity: 0.9;
        }

        /* –û–∫–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–π */
        .chat-messages {
            flex-grow: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏–π */
        .message {
            padding: 10px 15px;
            border-radius: 18px;
            max-width: 80%;
            line-height: 1.5;
            font-size: 0.95rem;
            white-space: pre-wrap; /* –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –∞–±–∑–∞—Ü—ã */
        }

        /* –°–æ–æ–±—â–µ–Ω–∏–µ –±–æ—Ç–∞ */
        .message.bot {
            background-color: #e9eef2;
            color: #333;
            border-bottom-left-radius: 4px;
            align-self: flex-start;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .message-text {
            flex-grow: 1;
        }

        /* –°–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è */
        .message.user {
            background-color: #0078d4;
            color: white;
            border-bottom-right-radius: 4px;
            align-self: flex-end;
        }

        /* –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ */
        .message.bot-loading {
            background-color: #e9eef2;
            color: #777;
            font-style: italic;
            border-bottom-left-radius: 4px;
            align-self: flex-start;
        }

        /* –§–æ—Ä–º–∞ –≤–≤–æ–¥–∞ */
        .chat-input-form {
            display: flex;
            align-items: center;
            border-top: 1px solid #ddd;
            padding: 10px;
            background-color: #f9f9f9;
            flex-shrink: 0;
        }

        #user-input {
            flex-grow: 1;
            border: 1px solid transparent;
            padding: 12px;
            border-radius: 20px;
            background-color: #eef2f5;
            font-size: 1rem;
            outline: none;
            transition: all 0.2s ease-in-out;
        }

        #user-input:focus {
            background-color: #fff;
            border-color: #0078d4;
        }

        /* –ö–Ω–æ–ø–∫–∏ */
        #send-btn, #mic-btn {
            border: none;
            background-color: transparent;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0 10px;
            color: #555;
            transition: color 0.2s, transform 0.2s;
        }
        
        #send-btn {
            color: #0078d4;
            margin-left: 5px;
        }

        #mic-btn:hover, #send-btn:hover {
            transform: scale(1.1);
        }
        
        /* –ò–∫–æ–Ω–∫–∞ –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞ */
        #mic-btn::before {
            content: 'üé§';
        }

        /* –°—Ç–∏–ª—å –¥–ª—è –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞ */
        #mic-btn.recording {
            color: #d90429;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }
    </style>
</head>
<body>
    <div class="chat-container">
        <div class="chat-header">
            <h2>Zaman Bank AI Assistant</h2>
            <p>–í–∞—à –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–π –ø–æ–º–æ—â–Ω–∏–∫</p>
        </div>
        <div class="chat-messages" id="chat-messages">
            <div class="message bot">
                 <span class="message-text">–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –Ø –≤–∞—à —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–π –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –Ω–∞ –±–∞–∑–µ AI. –Ø –º–æ–≥—É –ø–æ–º–æ—á—å –≤–∞–º —Å —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–º–∏ —Ü–µ–ª—è–º–∏, –ø–æ–¥–±–æ—Ä–æ–º –ø—Ä–æ–¥—É–∫—Ç–æ–≤ –∏ –º–Ω–æ–≥–∏–º –¥—Ä—É–≥–∏–º. –ß–µ–º –º–æ–≥—É –ø–æ–º–æ—á—å?</span>
            </div>
        </div>
        <div class="chat-input-form">
            <button id="mic-btn" title="–ì–æ–ª–æ—Å–æ–≤–æ–π –≤–≤–æ–¥"></button>
            <input type="text" id="user-input" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à –∑–∞–ø—Ä–æ—Å...">
            <button id="send-btn" title="–û—Ç–ø—Ä–∞–≤–∏—Ç—å">‚û§</button>
        </div>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const chatMessages = document.getElementById("chat-messages");
            const userInput = document.getElementById("user-input");
            const sendBtn = document.getElementById("send-btn");
            const micBtn = document.getElementById("mic-btn");

            const N8N_WEBHOOK_URL = "https://unreplete-kash-singly.ngrok-free.dev/webhook/5ac114ab-2b53-4dec-b78f-af8321a14c6a";

            /**
             * –î–æ–±–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –æ–∫–Ω–æ —á–∞—Ç–∞
             * @param {string} text - –¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è
             * @param {'user' | 'bot' | 'bot-loading'} sender - –û—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å
             */
            function addMessage(text, sender) {
                const messageDiv = document.createElement("div");
                messageDiv.classList.add("message", sender);

                const textSpan = document.createElement("span");
                textSpan.classList.add("message-text");
                textSpan.textContent = text;
                messageDiv.appendChild(textSpan);
                
                chatMessages.appendChild(messageDiv);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }

            /**
             * –û–∑–≤—É—á–∏–≤–∞–µ—Ç —Ç–µ–∫—Å—Ç
             * @param {string} text - –¢–µ–∫—Å—Ç –¥–ª—è –æ–∑–≤—É—á–∏–≤–∞–Ω–∏—è
             */
            function speakMessage(text) {
                // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–µ–µ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ, –µ—Å–ª–∏ –æ–Ω–æ –µ—Å—Ç—å
                window.speechSynthesis.cancel();
                
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'ru-RU'; // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ä—É—Å—Å–∫–∏–π —è–∑—ã–∫
                window.speechSynthesis.speak(utterance);
            }

            /**
             * –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –±–æ—Ç—É –∏ –ø–æ–ª—É—á–∞–µ—Ç –æ—Ç–≤–µ—Ç
             */
            async function handleSendMessage() {
                const messageText = userInput.value.trim();
                if (messageText === "") return;

                addMessage(messageText, "user");
                userInput.value = "";
                userInput.focus();
                
                addMessage("–ü–µ—á–∞—Ç–∞–µ—Ç...", "bot-loading");

                try {
                    const response = await fetch(N8N_WEBHOOK_URL, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ message: messageText }),
                    });

                    const loadingIndicator = document.querySelector(".bot-loading");
                    if(loadingIndicator) loadingIndicator.remove();

                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }

                    const data = await response.json();
                    const botReply = data?.[0]?.reply || "–ò–∑–≤–∏–Ω–∏—Ç–µ, —É –º–µ–Ω—è –Ω–µ—Ç –æ—Ç–≤–µ—Ç–∞.";

                    addMessage(botReply, "bot");
                    speakMessage(botReply); // –û–∑–≤—É—á–∏–≤–∞–µ–º –æ—Ç–≤–µ—Ç –±–æ—Ç–∞

                } catch (error) {
                    console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞—â–µ–Ω–∏–∏ –∫ n8n:", error);
                    const loadingIndicator = document.querySelector(".bot-loading");
                    if (loadingIndicator) loadingIndicator.remove();
                    
                    let errorMessage = `–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞: ${error.message}. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.`;
                    if (error instanceof SyntaxError) {
                        errorMessage = "–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞: –ø–æ–ª—É—á–µ–Ω –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –æ—Ç–≤–µ—Ç –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≤–æ—Ä–∫—Ñ–ª–æ—É.";
                    }
                    addMessage(errorMessage, "bot");
                }
            }

            // --- –õ–û–ì–ò–ö–ê –ì–û–õ–û–°–û–í–û–ì–û –í–í–û–î–ê ---
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            let recognition = null;

            if (SpeechRecognition) {
                recognition = new SpeechRecognition();
                recognition.lang = 'ru-RU';
                recognition.interimResults = false;

                micBtn.addEventListener("click", () => {
                    if (micBtn.classList.contains("recording")) {
                        recognition.stop();
                    } else {
                        recognition.start();
                    }
                });

                recognition.onstart = () => {
                    micBtn.classList.add("recording");
                    micBtn.disabled = true;
                };

                recognition.onresult = (event) => {
                    const transcript = event.results[0][0].transcript;
                    userInput.value = transcript;
                    handleSendMessage();
                };

                recognition.onend = () => {
                    micBtn.classList.remove("recording");
                    micBtn.disabled = false;
                };

                recognition.onerror = (event) => {
                    console.error("–û—à–∏–±–∫–∞ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è —Ä–µ—á–∏:", event.error);
                    if (event.error === 'no-speech') {
                         addMessage("–Ø –≤–∞—Å –Ω–µ —Ä–∞—Å—Å–ª—ã—à–∞–ª. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.", "bot");
                    }
                };
            } else {
                console.warn("Web Speech API –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –≤ —ç—Ç–æ–º –±—Ä–∞—É–∑–µ—Ä–µ.");
                micBtn.style.display = "none";
            }

            // --- –ù–∞–≤–µ—à–∏–≤–∞–µ–º —Å–æ–±—ã—Ç–∏—è ---
            sendBtn.addEventListener("click", handleSendMessage);
            userInput.addEventListener("keypress", (e) => {
                if (e.key === "Enter") {
                    e.preventDefault();
                    handleSendMessage();
                }
            });

            // –û–∑–≤—É—á–∏–≤–∞–µ–º –ø–µ—Ä–≤–æ–µ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
            const initialBotMessage = document.querySelector('.message.bot .message-text')?.textContent;
            if (initialBotMessage) {
                // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞, —á—Ç–æ–±—ã –±—Ä–∞—É–∑–µ—Ä —É—Å–ø–µ–ª –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å API
                setTimeout(() => speakMessage(initialBotMessage), 500);
            }
        });
    </script>
</body>
</html>
